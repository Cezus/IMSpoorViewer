<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.10.1/css/ol.css" type="text/css">
    <style>
      .map {
        height: 600px;
        width: 100%;
      }
    </style>
    <script src="http://openlayers.org/en/v3.10.1/build/ol.js" type="text/javascript"></script>
    <script src="proj4.js" type="text/javascript"></script>
	<script>
		var map,vector;
		var image = new ol.style.Circle({
			radius: 5,
			stroke: new ol.style.Stroke({color: 'red', width: 4})
		});
		var styles = {
		  'Point': [new ol.style.Style({
			image: image,
			text: new ol.style.Text({
				text: '',
				fill: new ol.style.Fill({color: 'red'}),
				stroke: new ol.style.Stroke({color: 'red', width: 1}),
				offsetX: 0,
				offsetY: 0,
			})
		  })],
		  'LineString': [new ol.style.Style({
			stroke: new ol.style.Stroke({
			  color: 'blue',
			  width: 4
			}),
			text: new ol.style.Text({
				text: '',
				fill: new ol.style.Fill({color: 'black'}),
				stroke: new ol.style.Stroke({color: 'black', width: 1}),
				offsetX: 0,
				offsetY: 0,
			})
		  })]		  
		};
		
		var styleFunction = function(feature, resolution) {
			var ft = feature.getGeometry().getType();
			var style;
			if(ft == 'Point'){
				style = new ol.style.Style({
					image: image,
					text: new ol.style.Text({
						text: feature.get('label'),
						fill: new ol.style.Fill({color: 'red'}),
						stroke: new ol.style.Stroke({color: 'red', width: 1}),
						offsetX: 0,
						offsetY: -10,
					})
				});
			}
			else if(ft == 'LineString'){
				style = new ol.style.Style({
					stroke: new ol.style.Stroke({
					  color: 'blue',
					  width: 4
					}),
					text: new ol.style.Text({
						text: feature.get('label'),
						fill: new ol.style.Fill({color: 'blue'}),
						stroke: new ol.style.Stroke({color: 'blue', width: 1}),
						offsetX: 0,
						offsetY: -5,
					})
				});
			}
			//style = new ol.style.Style({image: image});
			//console.log('style: '+JSON.stringify(style));
			return [style];
		};
		
		function handleFileSelect(evt) {
			evt.stopPropagation();
			evt.preventDefault();

			var files = evt.dataTransfer.files; // FileList object.

			// files is a FileList of File objects. List some properties.
			var output = [];
			for (var i = 0, f; f = files[i]; i++) {
			   var reader = new FileReader();
			   reader.onload = 
					function(event){
						var text = event.target.result;
						parseAndRenderIMX(text);
					};
			   reader.onerror = function(event){
					console.log('file-error: '+event.target.error.code);
			   };
			   reader.readAsText(f);
			   
			}
		}
		
		function parseAndRenderIMX(text){
			var parser = new DOMParser();
			var xmlDoc = parser.parseFromString(text,"text/xml");
			procesTracks(xmlDoc);
			procesJunctions(xmlDoc);
			map.render();
		}
		
		function procesJunctions(xmlDoc){
			var junctions = xmlDoc.getElementsByTagName("Junction");
			console.log('Juntions gevonden: '+junctions.length);
			//var poslistValue = ;
			for(var i=0;i<junctions.length;i++){
				var poslist = junctions[i].getElementsByTagName("posList")[0].childNodes[0];
				if(poslist != undefined){
					var coordValues = poslist.nodeValue.split(' ');
					var point = new ol.geom.Point([coordValues[0],coordValues[1]]);
					point.transform(ol.proj.get("EPSG:28992"),map.getView().getProjection());
					var junctionName =junctions[i].attributes[1].nodeValue;
					var junctionPuic = junctions[i].attributes[0].nodeValue;
					var feature = new ol.Feature({
					  geometry: point,
					  name: junctionPuic,
					  label: junctionName
					});
					vector.getSource().addFeature(feature);
				}
			}
		}
		
		function procesTracks(xmlDoc){
			var tracks = xmlDoc.getElementsByTagName("Track");
			console.log('tracks gevonden: '+tracks.length);
			//var poslistValue = ;
			for(var i=0;i<tracks.length;i++){
				var poslist = tracks[i].getElementsByTagName("posList")[0].childNodes[0];
				if(poslist != undefined){
					var coordinates = [];
					var coordValues = poslist.nodeValue.split(' ');
					for(var j=0;j<coordValues.length;j+=2){
						coordinates.push([coordValues[j],coordValues[j+1]]);
					}
					var line = new ol.geom.LineString(coordinates);
					line.transform(ol.proj.get("EPSG:28992"),map.getView().getProjection());
					var trackName = tracks[i].attributes[1].value;
					var trackPuic = tracks[i].attributes[0].value;
					var feature = new ol.Feature({
					  geometry: line,
					  name: trackPuic,
					  label: trackName
					});
					vector.getSource().addFeature(feature);
				}
			}
		}

		function handleDragOver(evt) {
			evt.stopPropagation();
			evt.preventDefault();
			evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
		}
		
		function init(){
			// Setup the dnd listeners.
			var dropZone = document.getElementById('drop_zone');
			dropZone.addEventListener('dragover', handleDragOver, false);
			dropZone.addEventListener('drop', handleFileSelect, false);	
			// setup projectie
			proj4.defs("EPSG:28992", "+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +towgs84=565.040,49.910,465.840,-0.40939,0.35971,-1.86849,4.0772");
			
			vector = new ol.layer.Vector({
				style: styleFunction,
				source: new ol.source.Vector({
				})				
			});
			
			var tile = new ol.layer.Tile({
				source: new ol.source.OSM()
			});
		
            map = new ol.Map({
				target: 'map',				
				layers: [tile,vector],
				view: new ol.View({
				  center: ol.proj.fromLonLat([5.3,52.23]),
				  zoom: 8 
				})
			});
        }
	</script>
    <title>OpenLayers 3 example</title>
  </head>
  <body onload="init()">
    <h2>My Map</h2>
    <div id="map" class="map"></div>
	<div id="drop_zone" style="border: 3px coral solid; height: 100px; width: 50%;">Sleep hier een IMX bestand in</div>
	<p>Download hier een voorbeeld bestand:<br/>
	<a href="IMSpoor.xml" download>Valburg</a>
	</p>
  </body>
</html>


        
    